<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro Bicicletário - Prefeitura de Japeri</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    .top-nav-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 10px; /* Spacing between buttons */
    }
    .top-nav-link {
      /* position, top, right are now handled by the container */
      background-color: #007bff;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 0.9em;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .top-nav-link:hover {
      background-color: #0056b3;
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      background-color: #e9f5f1;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #333;
      min-height: 100vh;
    }

    header {
      width: 100%;
      background-color: #005f73;
      color: white;
      padding: 20px 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    header img {
      height: 70px;
      width: auto;
      display: block;
      margin: 0 auto 2px auto;
    }

    header h1 {
      font-size: 1.7em;
      margin: 0;
      text-align: center;
      width: 100%;
    }

    .container-form {
      width: 95%;
      max-width: 600px;
      margin: 30px auto;
    }

    form {
      background: #fff;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
    }

    form h2 {
      color: #005f73;
      text-align: center;
      margin-top: 0;
      margin-bottom: 25px;
      font-size: 1.8em;
    }

    label {
      margin-top: 15px;
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="time"],
    input[type="file"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ade8f4;
      box-sizing: border-box;
      background-color: #f8f9fa;
      transition: border-color 0.3s ease;
    }

    input[type="file"] {
      padding: 8px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    button[type="submit"] {
      margin-top: 30px;
      width: 100%;
      padding: 12px 15px;
      background: #2a9d8f;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    button[type="submit"]:hover {
      background: #268378;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    footer {
      text-align: center;
      background-color: #003440;
      color: white;
      padding: 20px;
      width: 100%;
      font-size: 15px;
      margin-top: auto;
    }

    footer br {
      margin-bottom: 5px;
    }

    /* Estilos para Impressão do Cartão  */
    @media print {
      body * {
        visibility: hidden;
      }
      #modalCartao, #modalCartao > div, #cartaoAcesso, #cartaoAcesso * {
        visibility: visible;
      }

      #modalCartao {
        position: static !important; 
        width: auto !important;
        height: auto !important;
        background: none !important;
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 !important;
        display: block !important;
        overflow: visible !important;
      }
      #modalCartao > div { 
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 !important;
        border: none !important;
        max-width: none !important;
        width: auto !important;
        background: none !important;
      }
      #cartaoAcesso {
        width: 8.56cm !important;  
        height: 5.398cm !important; 
        box-shadow: none !important;
        margin: 1cm auto; 
        border: 1px dashed #888; 
        border-radius: 3.18mm; 
        overflow: hidden;
        box-sizing: border-box;
      }
      
      #modalCartao span[onclick*="modalCartao"], 
      #modalCartao div[style*="text-align:center; margin-top:18px;"] { 
        display: none !important;
      }

      img {
        -webkit-print-color-adjust: exact !important; 
        print-color-adjust: exact !important; 
      }

      @page {
        size: A4 portrait; 
        margin: 0; 
      }
    }
  </style>
</head>
<body>
  <div class="top-nav-container">
    <a href="area-funcionario.html" class="top-nav-link">Área do Funcionário</a>
    <a href="listadecadastro.html" class="top-nav-link">Controle de Acesso</a>
  </div>
<script>
  if (sessionStorage.getItem('autenticado') !== 'true') {
    window.location.href = 'acesso-funcionarios.html';
  }
</script>


  <header>
    <img src="imagens/image.png" alt="Prefeitura de Japeri">
    <h1>Prefeitura de Japeri - Bicicletário</h1>
  </header>
  <div style="text-align:center; margin: 20px 0;">
    <a href="listadecadastro.html" style="display:inline-block; padding:10px 22px; background:#2a9d8f; color:white; border-radius:7px; text-decoration:none; font-weight:bold; font-size:1.05em; transition:background 0.2s;">Ver Lista de Cadastros</a>
  </div>

  <div class="container-form">
    <form id="formBicicletario">
      <h2>Cadastro de Bicicleta</h2>
      
      <label for="nome">Nome Completo do Proprietário:</label>
      <input type="text" id="nome" required>

      <label for="email">Email:</label>
      <input type="email" id="email">

      <label for="cpf">CPF:</label>
      <input type="text" id="cpf" required>

      <label for="contato">Contato (Telefone/WhatsApp):</label>
      <input type="tel" id="contato">

      <label for="endereco">Endereço:</label>
      <input type="text" id="endereco" required>

      <label for="numero_bike">Número de Identificação da Bicicleta (Chassi/Quadro):</label>
      <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="numero_bike" name="numero_bike" required style="flex-grow: 1;">
        <button type="button" id="btnGerarNumeroBike" style="padding: 10px 15px; white-space: nowrap; background-color: #007bff; color:white; border:none; border-radius:6px; cursor:pointer;">Gerar ID</button>
      </div>

      <label for="tipo_bike">Tipo de Bicicleta:</label>
      <select id="tipo_bike" required>
        <option value="">Selecione o Tipo</option>
        <option value="Mountain Bike">Mountain Bike</option>
        <option value="Speed">Speed</option>
        <option value="Urbana">Urbana</option>
        <option value="Elétrica">Elétrica</option>
        <option value="Dobrável">Dobrável</option>
        <option value="Infantil">Infantil</option>
        <option value="Outro">Outro</option>
      </select>

      <label for="marca">Marca:</label>
      <input type="text" id="marca" required>

      <label for="modelo">Modelo:</label>
      <input type="text" id="modelo" required>

      <label for="observacoes">Características Distintivas / Observações:</label>
      <textarea id="observacoes" rows="3"></textarea>





      <label for="foto">Foto do Proprietário (opcional, para identificação):</label>
<input type="file" id="foto" accept="image/*">

<label for="foto_bike">Foto do Proprietário com a Bicicleta (opcional):</label>
<input type="file" id="foto_bike" accept="image/*">
      
      <button type="submit">Cadastrar Bicicleta</button>
    </form>
  </div>

  <!-- Ficha Detalhada do Proprietário e Bicicleta (aparece após cadastro) -->
  <div id="fichaDetalhada" style="display:none; width:95%; max-width:700px; margin: 20px auto; background: #fff; padding: 25px 30px; border-radius: 12px; box-shadow: 0 12px 32px rgba(0,0,0,0.15);">
    <h2 style="color: #005f73; text-align: center; margin-top: 0; margin-bottom: 25px;">Ficha Detalhada do Proprietário</h2>
    <div style="margin-bottom: 20px;">
      <strong>Nome:</strong> <span id="fichaNome"></span><br>
      <strong>Email:</strong> <span id="fichaEmail"></span><br>
      <strong>CPF:</strong> <span id="fichaCpf"></span><br>
      <strong>Contato:</strong> <span id="fichaContato"></span><br>
      <strong>Endereço:</strong> <span id="fichaEndereco"></span><br>
      <strong>Foto do Proprietário:</strong><br>
      <img id="fichaFotoProprietario" src="#" alt="Foto do Proprietário" style="max-width:150px; max-height:150px; margin-top:10px; border:1px solid #ddd; display:none;">
      <br><strong>Foto do Proprietário com a Bicicleta:</strong><br>
      <img id="fichaFotoDonoComBicicleta" src="#" alt="Foto do Dono com a Bicicleta" style="max-width:150px; max-height:110px; margin-top:10px; border:1px solid #ddd; display:none;">
    </div>
    <hr style="margin: 30px 0;">
    <button id="btnFichaCartao" type="button" style="background:#2a9d8f; color:white; border:none; border-radius:8px; padding:10px 18px; font-size:1em; font-weight:bold; margin-bottom:18px; cursor:pointer; display:block; margin-left:auto; margin-right:auto;">Gerar Cartão de Acesso</button>
    <h2 style="color: #005f73; text-align: center; margin-top: 0; margin-bottom: 25px;">Dados da Bicicleta</h2>
    <div style="margin-bottom: 20px;">
      <strong>Nº Identificação:</strong> <span id="fichaBikeNumeroID"></span><br>
      <strong>Tipo:</strong> <span id="fichaBikeTipo"></span><br>
      <strong>Marca:</strong> <span id="fichaBikeMarca"></span><br>
      <strong>Modelo:</strong> <span id="fichaBikeModelo"></span><br>
      <strong>Observações:</strong> <span id="fichaBikeObservacoes"></span><br>


      <strong>Data do Cadastro:</strong> <span id="fichaDataCadastro"></span><br>
      <strong>Tipo:</strong> <span id="fichaBikeTipo"></span><br>
      <strong>Marca:</strong> <span id="fichaBikeMarca"></span><br>
      <strong>Modelo:</strong> <span id="fichaBikeModelo"></span><br>
      <strong>Observações:</strong> <span id="fichaBikeObs"></span><br>
      <strong>Foto do Dono com Bicicleta:</strong><br>
      <img id="fichaFotoDonoComBicicleta" src="#" alt="Foto Dono com Bicicleta" style="max-width:150px; max-height:150px; margin-top:10px; border:1px solid #ddd; display:none;">
    </div>
    <div style="text-align:right;">
      <button type="button" id="btnGerarCartaoFicha" style="padding:10px 20px; background:#2a9d8f; color:white; border:none; border-radius:8px; cursor:pointer; font-size:1em;">Gerar Cartão de Acesso</button>
    </div>
  </div>

  <footer>
    Prefeitura Municipal de Japeri<br>
    Secretaria de Transporte e Mobilidade Urbana<br>
    É tempo de fazer mais!
  </footer>

  <div id="modalCartao" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:9999;">
    <div style="background:white; border-radius:16px; padding:24px; box-shadow:0 8px 32px rgba(0,0,0,0.3); position:relative; max-width:450px; margin:auto;">
      <span onclick="document.getElementById('modalCartao').style.display='none'" style="position:absolute; top:10px; right:18px; font-size:2em; color:#888; cursor:pointer;">&times;</span>
      <div id="cartaoAcesso" style="width:390px; height:260px; position:relative; border-radius:12px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.20);">
        <img src="imagens/cartao-fundo.png" alt="Fundo do Cartão" style="position:absolute; left:0; top:0; width:100%; height:100%; object-fit:cover; border-radius:12px; z-index:0; pointer-events:none;" />
        
        <img id="cartaoFoto" src="" alt="Foto do Proprietário" style="
  position: absolute;
  left: 50px;
  top: 99px;
  width: 78px;
  height: 78px;
  border-radius: 7px;
  object-fit: cover;
  border: none;
  background: transparent;
  z-index: 1;" />

<!-- Nova imagem: Proprietário com a bicicleta -->
<img id="cartaoFotoBike" src="" alt="Foto do Proprietário com a Bicicleta" style="
  position: absolute;
  left: 142px;
  top: 99px;
  width: 78px;
  height: 54px;
  border-radius: 7px;
  object-fit: cover;
  border: none;
  background: transparent;
  z-index: 1;
  display: none;" />
        
        <div id="cartaoNumeroGrande" style="
          position: absolute;
          left: 142px;
          top: 120px;
          width: 195px;
          height: 28px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1.2em;
          font-weight: bold;
          color: #0D47A1;
          letter-spacing: 0.5px;
          background: transparent;
          z-index: 1;
          text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.3);"></div>
        
        <div id="cartaoQR" style="
          position: absolute;
          right: 43px;
          bottom: 50px;
          width: 58px;
          height: 58px;
          background: white;
          border-radius: 0px;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 1px;
          z-index: 1;"></div>
        
        <div id="cartaoNome" style="
          position: absolute;
          left: 51px;
          top: 177px;
          font-size: 0.75em;
          font-weight: bold;
          color: #333333;
          width: 240px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          z-index: 1;"></div>

        <div id="cartaoInfoBicicleta" style="
          position: absolute;
          left: 51px;
          top: 194px;
          font-size: 0.8em;
          color: #1A1A1A;
          width: 250px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          z-index: 1;"></div>
        
        <div id="cartaoRodapeTexto" style="
          position: absolute;
          left: 51px;
          bottom: 37px;
          font-size: 0.46875em;
          color: #1A1A1A;
          width: 400px; /* Atenção: 400px é maior que a largura do cartão (390px), pode vazar. Ajuste se necessário */
          line-height: 1.2;
          z-index: 1;">Documento pessoal e intransferível. Em caso de perda, comunique à administração.</div>
      </div>
      <div style="text-align:center; margin-top:18px;">
        <button onclick="imprimirCartao()" style="padding:8px 18px; border:none; background:#2a9d8f; color:white; border-radius:8px; font-size:1em; cursor:pointer;">Imprimir Cartão</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    // Configuração da URL base da API
    const API_BASE_URL = 'https://bicicletario-backend.onrender.com';
    // Helper function to read file as Data URL
    async function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Exibe a ficha detalhada do proprietário e da bicicleta
    function exibirFichaDetalhada(cadastro) {
      document.getElementById('fichaDetalhada').style.display = 'block';
      document.getElementById('fichaNome').textContent = cadastro.nome || '';
      document.getElementById('fichaEmail').textContent = cadastro.email || '';
      document.getElementById('fichaCpf').textContent = cadastro.cpf || '';
      document.getElementById('fichaContato').textContent = cadastro.contato || '';
      document.getElementById('fichaEndereco').textContent = cadastro.endereco || '';
      
      // Foto do proprietário
      const fichaFoto = document.getElementById('fichaFotoProprietario');
      if (cadastro.fotoProprietario) {
        fichaFoto.src = cadastro.fotoProprietario;
        fichaFoto.style.display = 'block';
      } else {
        fichaFoto.src = '#'; // Clear src or set to placeholder
        fichaFoto.style.display = 'none';
      }
      
      // Foto do dono com a bicicleta
      const fichaFotoBike = document.getElementById('fichaFotoDonoComBicicleta');
      if (cadastro.fotoDonoComBicicleta) {
        fichaFotoBike.src = cadastro.fotoDonoComBicicleta;
        fichaFotoBike.style.display = 'block';
      } else {
        fichaFotoBike.src = '#'; // Clear src or set to placeholder
        fichaFotoBike.style.display = 'none';
      }
      
      document.getElementById('fichaBikeNumeroID').textContent = cadastro.numero_bike || cadastro.numeroBike || ''; // numero_bike from form, numeroBike if backend uses that
      document.getElementById('fichaBikeTipo').textContent = cadastro.tipo_bike || cadastro.tipoBike || '';
      document.getElementById('fichaBikeMarca').textContent = cadastro.marca || '';
      document.getElementById('fichaBikeModelo').textContent = cadastro.modelo || '';
      document.getElementById('fichaBikeObservacoes').textContent = cadastro.observacoes || '';
      
      // Fields not in the primary registration form, will be blank or default if not in 'cadastro' object


      document.getElementById('fichaDataCadastro').textContent = cadastro.dataCadastro || new Date().toLocaleDateString('pt-BR');
      
      // Botão para gerar cartão - corrected ID
      const btnCartao = document.getElementById('btnGerarCartaoFicha'); 
      btnCartao.onclick = function() {
        // Ensure 'id' is present in cadastro for the card
        const idParaCartao = cadastro.id || result?.proprietario?.id || result?.bicicleta?.id || cadastro.numero_bike;
        const cadastroParaCartao = {
            ...cadastro,
            id: idParaCartao
        };
        mostrarCartaoAcesso(cadastroParaCartao, cadastro.fotoProprietario, cadastro.fotoDonoComBicicleta);
      };
    }

    const form = document.getElementById('formBicicletario');

    // Preenche automaticamente os campos de hora com o horário atual
    function preencherHorasAutomaticamente() {
      const agora = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const horaAtual = pad(agora.getHours()) + ':' + pad(agora.getMinutes());
      const saida = new Date(agora.getTime() + 60*60000); // +1 hora para saída (example)
      const horaSaida = pad(saida.getHours()) + ':' + pad(saida.getMinutes());
      // These are for the example form fields, not directly used by Ficha Detalhada unless mapped
      // document.getElementById('horaEntrada').value = horaAtual; 
      // document.getElementById('horaSaida').value = horaSaida;
    }
    window.addEventListener('DOMContentLoaded', preencherHorasAutomaticamente);
    form.addEventListener('reset', function() {
      setTimeout(preencherHorasAutomaticamente, 0);
      document.getElementById('fichaDetalhada').style.display = 'none'; // Hide ficha on form reset
    });

    form.addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const token = sessionStorage.getItem('token');
  if (!token) {
      alert("Sessão inválida. Faça o login novamente.");
      return;
  }

  // Validar se os dados inseridos são reais
  const nome = document.getElementById('nome').value.trim();
  const cpf = document.getElementById('cpf').value.trim();
  const email = document.getElementById('email').value.trim();
  const contato = document.getElementById('contato').value.trim();
  const endereco = document.getElementById('endereco').value.trim();
  const numero_bike = document.getElementById('numero_bike').value.trim();

  // Validação de CPF
  if (!/^\d{11}$|^\d{3}\.\d{3}\.\d{3}\-\d{2}$/.test(cpf)) {
    alert("Por favor, insira um CPF válido (11 dígitos).");
    return;
  }

  // Validação de e-mail
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    alert("Por favor, insira um e-mail válido.");
    return;
  }

  // Validação de contato
  if (!/^\(?\d{2}\)?[\s\-]?\d{4,5}[\-\s]?\d{4}$/.test(contato)) {
    alert("Por favor, insira um número de telefone válido.");
    return;
  }

  // Validar se os campos obrigatórios têm comprimento mínimo
  if (nome.length < 5) {
    alert("Por favor, insira o nome completo do proprietário.");
    return;
  }

  if (endereco.length < 5) {
    alert("Por favor, insira um endereço válido.");
    return;
  }

  if (numero_bike.length < 4) {
    alert("Por favor, insira um número de identificação válido para a bicicleta.");
    return;
  }

  // FormData é o objeto para enviar formulários com arquivos
  const formData = new FormData();

  // Adiciona os campos de texto ao FormData
  formData.append('nome', document.getElementById('nome').value.trim());
  formData.append('email', document.getElementById('email').value.trim());
  formData.append('cpf', document.getElementById('cpf').value.trim());
  formData.append('contato', document.getElementById('contato').value.trim());
  formData.append('endereco', document.getElementById('endereco').value.trim());
  formData.append('numero_bike', document.getElementById('numero_bike').value.trim());
  formData.append('tipo_bike', document.getElementById('tipo_bike').value);
  formData.append('marca', document.getElementById('marca').value.trim());
  formData.append('modelo', document.getElementById('modelo').value.trim());
  formData.append('observacoes', document.getElementById('observacoes').value.trim());

  // Adiciona os arquivos de imagem ao FormData, se foram selecionados
  const fotoProprietarioInput = document.getElementById('foto');
  const fotoBikeInput = document.getElementById('foto_bike'); 
  // Você precisará adicionar o campo para 'fotoBicicleta' no seu HTML para as 3 fotos
  // const fotoBicicletaSozinhaInput = document.getElementById('foto_bicicleta_sozinha'); 

  if (fotoProprietarioInput.files[0]) {
    formData.append('fotoProprietario', fotoProprietarioInput.files[0]);
  }
  // O campo 'foto_bike' no HTML atual corresponde a 'fotoDonoComBicicleta' na lógica do backend
  if (fotoBikeInput.files[0]) {
    formData.append('fotoDonoComBicicleta', fotoBikeInput.files[0]);
  }
  // Para a foto da bicicleta sozinha, você precisaria de um input com id, por exemplo, 'foto_bicicleta_sozinha'
  // E então: 
  const fotoBicicletaSozinhaInput = document.getElementById('foto_bicicleta_sozinha'); // Supondo que você adicione este ID ao HTML
  if (fotoBicicletaSozinhaInput && fotoBicicletaSozinhaInput.files[0]) {
    formData.append('fotoBicicleta', fotoBicicletaSozinhaInput.files[0]);
  }
  
  try {
    const response = await fetch(`${API_BASE_URL}/api/cadastros`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token
      },
      body: formData // Envia o objeto FormData
    });

    const result = await response.json();

    if (!response.ok) {
      throw new Error(result.erro || `Erro HTTP: ${response.status}`);
    }

    alert(result.mensagem || "Cadastro realizado com sucesso!");
    form.reset();

    if (result.proprietario && result.proprietario.id) {
      window.location.href = `ficha_proprietario.html?id=${result.proprietario.id}`;
    }

  } catch (error) {
    console.error("Erro ao cadastrar:", error);
    alert("Falha no cadastro: " + error.message);
  }
});

    function redimensionarImagem(base64, targetWidth, targetHeight, callback) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        const ctx = canvas.getContext('2d');
        const originalAspectRatio = img.width / img.height;
        const targetAspectRatio = targetWidth / targetHeight;
        let sourceX = 0, sourceY = 0, sourceWidth = img.width, sourceHeight = img.height;
        if (originalAspectRatio > targetAspectRatio) {
            sourceWidth = img.height * targetAspectRatio;
            sourceX = (img.width - sourceWidth) / 2;
        } else if (originalAspectRatio < targetAspectRatio) {
            sourceHeight = img.width / targetAspectRatio;
            sourceY = (img.height - sourceHeight) / 2;
        }
        ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, targetWidth, targetHeight);
        callback(canvas.toDataURL('image/jpeg', 0.85));
      };
      img.src = base64;
    }

    function mostrarCartaoAcesso(cadastro, fotoBase64Data, fotoBikeBase64Data) {
      document.getElementById('modalCartao').style.display = 'flex';
      const fotoPadrao = 'https://via.placeholder.com/150x150/cccccc/666666?text=Foto'; 
      const cartaoFotoEl = document.getElementById('cartaoFoto');
      const cartaoFotoBikeEl = document.getElementById('cartaoFotoBike');

      // Foto do dono
      const targetFotoWidth = parseInt(cartaoFotoEl.style.width) || 78; 
      const targetFotoHeight = parseInt(cartaoFotoEl.style.height) || 78;
      if (fotoBase64Data) {
        redimensionarImagem(fotoBase64Data, targetFotoWidth, targetFotoHeight, function(fotoReduzida) {
          cartaoFotoEl.src = fotoReduzida;
        });
      } else {
        cartaoFotoEl.src = fotoPadrao;
      }
      // Foto do dono com a bicicleta
      const targetFotoBikeWidth = parseInt(cartaoFotoBikeEl.style.width) || 78;
      const targetFotoBikeHeight = parseInt(cartaoFotoBikeEl.style.height) || 54;
      if (fotoBikeBase64Data) {
        redimensionarImagem(fotoBikeBase64Data, targetFotoBikeWidth, targetFotoBikeHeight, function(fotoReduzida) {
          cartaoFotoBikeEl.src = fotoReduzida;
          cartaoFotoBikeEl.style.display = 'block';
        });
      } else {
        cartaoFotoBikeEl.src = '';
        cartaoFotoBikeEl.style.display = 'none';
      }
      
      document.getElementById('cartaoNome').textContent = cadastro.nome || '';
      document.getElementById('cartaoNumeroGrande').textContent = cadastro.id ? cadastro.id.toString() : (cadastro.numero_bike || '');
      document.getElementById('cartaoInfoBicicleta').textContent = 'Bicicleta: ' + (cadastro.marca || '') + ' ' + (cadastro.modelo || '');
      
      const qrDiv = document.getElementById('cartaoQR');
      qrDiv.innerHTML = ''; 
      const qrCodeSize = parseInt(qrDiv.style.width) || 58;
      
      const qrText = `ID: ${cadastro.id || cadastro.numero_bike || ''}\nNome: ${cadastro.nome || ''}\nBike: ${cadastro.marca || ''} ${cadastro.modelo || ''}`;
      new QRCode(qrDiv, {
        text: qrText,
        width: qrCodeSize,
        height: qrCodeSize, 
        colorDark : '#000000',
        colorLight : '#ffffff',
        correctLevel : QRCode.CorrectLevel.M 
      });
    }

    function imprimirCartao() {
      window.print();
    }

  </script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnGerarNumeroBike = document.getElementById('btnGerarNumeroBike');
    const inputNumeroBike = document.getElementById('numero_bike');
    if (btnGerarNumeroBike && inputNumeroBike) {
        btnGerarNumeroBike.addEventListener('click', () => {
            inputNumeroBike.value = gerarCodigoAlfanumericoUnico();
        });
    }
});

function gerarCodigoAlfanumericoUnico(tamanho = 10) {
  const prefixo = "JPR-";
  const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let codigo = '';
  for (let i = 0; i < tamanho; i++) {
    codigo += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
  }
  const timestampPart = Date.now().toString().slice(-4);
  return prefixo + codigo + timestampPart;
}
</script>
</body>
</html>
