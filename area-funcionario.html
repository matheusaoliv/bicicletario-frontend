<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Biciclet√°rio de Japeri</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/area-funcionario.css">

<style>
/* RESPONSIVIDADE TOTAL - CSS INLINE INSERIDO AUTOMATICAMENTE */
.dashboard-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
  gap: 1.2rem;
  padding: 1.2rem;
  box-sizing: border-box;
}
.summary-cards {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  width: 100%;
}
.summary-card {
  flex: 1 1 160px;
  min-width: 140px;
  margin: 0.2rem 0;
}
.card {
  min-width: 0;
  box-sizing: border-box;
}

@media (max-width: 1100px) {
  .dashboard-container {
    grid-template-columns: 1fr 1fr;
  }
}
@media (max-width: 900px) {
  .dashboard-container {
    grid-template-columns: 1fr !important;
    gap: 0.7rem;
    padding: 0.5rem;
  }
  .summary-cards {
    flex-direction: column;
    gap: 0.5rem;
  }
  .card {
    padding: 0.7rem;
    font-size: 0.97rem;
  }
  .card-title {
    font-size: 1rem;
  }

}
@media (max-width: 600px) {
  .dashboard-container {
    padding: 0.2rem;
  }
  .card, .summary-card {
    padding: 0.4rem;
    font-size: 0.91rem;
  }
  .card-title {
    font-size: 0.97rem;
  }
}
.header, .header-info {
  flex-wrap: wrap;
  gap: 0.5rem;
}
@media (max-width: 700px) {
  .header, .header-info {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 0.3rem !important;
  }
}
/* FIM RESPONSIVIDADE TOTAL */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.btn-atualizar-mapa {
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
}
.carregando-mapa {
    text-align: center;
    padding: 20px;
}

        /* Estilos Completos do Dashboard */
        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #333;
            --header-bg-color: #005f73;
            --header-text-color: #ffffff;
            --accent-color: #2a9d8f;
            --shadow-color: rgba(0,0,0,0.08);
        }
        body.dark-theme {
            --bg-color: #2c3e50;
            --card-bg-color: #34495e;
            --text-color: #ecf0f1;
            --header-bg-color: #27ae60;
            --accent-color: #2ecc71;
            --shadow-color: rgba(0,0,0,0.2);
        }
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .header {
            background-color: var(--header-bg-color);
            color: var(--header-text-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { margin: 0; font-size: 1.5rem; }
        .header-info { display: flex; align-items: center; gap: 1.5rem; font-size: 0.9rem; }
        .header-info a { color: #ffdddd; text-decoration: none; font-weight: bold; }
        .header-info a:hover { text-decoration: underline; }
        .theme-switch-wrapper { display: flex; align-items: center; gap: 8px; font-weight: 500;}
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(24px); }
        .dashboard-container { padding: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1.5rem; align-items: stretch; }
@media (min-width: 1100px) {
  .dashboard-container {
    grid-template-columns: repeat(4, 1fr);
  }
  .dashboard-container .card.-destaque {
    grid-column: span 2;
    min-width: 0;
  }
}
        .card { background-color: var(--card-bg-color); border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); padding: 1.5rem; display: flex; flex-direction: column; }
        .card-title { margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 500; color: var(--accent-color); }
        .summary-cards { grid-column: 1 / -1; display: flex; justify-content: space-around; gap: 1rem; flex-wrap: wrap; }
        .summary-card { background-color: var(--card-bg-color); border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); padding: 1.5rem; flex: 1; min-width: 160px; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 0.5rem; }
        .summary-card .value { font-size: 2.2rem; font-weight: 700; color: var(--accent-color); }
        .summary-card .label { font-size: 0.9rem; color: #666; }
        body.dark-theme .summary-card .label { color: #bdc3c7; }
        .activity-feed { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
        .activity-feed li { padding: 0.75rem 0; border-bottom: 1px solid var(--bg-color); }
        .activity-feed li:last-child { border-bottom: none; }
        .activity-feed .time { font-size: 0.8rem; color: #7f8c8d; margin-right: 1rem; }
        body.dark-theme .activity-feed .time { color: #95a5a6; }
        .activity-feed .type-entrada { color: #27ae60; font-weight: bold; }
        .activity-feed .type-saida { color: #e67e22; font-weight: bold; }
        .activity-feed .type-cadastro { color: #2980b9; font-weight: bold; }
    
canvas {
  min-width: 200px;
  min-height: 200px;
  display: block;
  /* background: transparent; */
  border-radius: 8px;
  margin: 0 auto 1em auto;
}
</style>
</head>
<body>
    <header class="header">
        <h1>Painel de Controle</h1>
        <div class="header-info">
            <span id="welcomeMessage">Bem-vindo(a)!</span>

        <div class="filtro-local-wrapper">
            <label for="filtroLocal" class="filtro-local-label">Ver Dados de:</label>
            <select id="filtroLocal" class="filtro-local-select">
                <option value="todos">Todos os Locais</option>
                <option value="Japeri">Biciclet√°rio de Japeri</option>
                <option value="Engenheiro Pedreira">Biciclet√°rio de Engenheiro Pedreira</option>
            </select>
            <label for="filtroData" class="filtro-data-label" style="margin-left:8px;">Dia:</label>
            <input type="date" id="filtroData" class="filtro-data-select" style="margin-right:12px;">
            <a href="listadecadastro.html">Controle de Acesso</a>
            <a href="cadastrobicicletario.html">Novo Cadastro</a>
            <a href="adicionar-bicicleta.html">Adicionar Bicicleta</a>
            <a href="admin.html">Administra√ß√£o</a>
            <a href="#" id="logoutBtn">Sair</a>
            <div class="theme-switch-wrapper">
                <span>Modo Escuro</span>
                <label class="theme-switch" for="theme-toggle">
                    <input type="checkbox" id="theme-toggle" />
                    <div class="slider"></div>
                </label>
            </div>
        </div>
        </div>
    </header>

    <main class="dashboard-container">
        <div class="summary-cards">
            <div class="summary-card" id="cardEstacionadas" style="cursor:pointer">
                <div class="value" id="totalEstacionadas">--</div>
                <div class="label">Bicicletas Estacionadas</div>
            </div>
            <div class="summary-card" id="cardEntradasHoje" style="cursor:pointer">
                <div class="value" id="totalEntradasHoje">--</div>
                <div class="label">Entradas Hoje</div>
            </div>
            <div class="summary-card" id="cardSaidasHoje" style="cursor:pointer">
                <div class="value" id="totalSaidasHoje">--</div>
                <div class="label">Sa√≠das Hoje</div>
            </div>
            <div class="summary-card">
                <div class="value" id="totalOcorrencias">--</div>
                <div class="label">Ocorr√™ncias Hoje</div>
            </div>
        </div>

        <!-- Modal de Bicicletas Estacionadas -->
        <div id="modalEstacionadas" class="modal-estacionadas" style="display:none;">
            <div class="modal-content">
                <span class="close-modal" id="closeModalEstacionadas">&times;</span>
                <h2>Bicicletas Estacionadas</h2>
                <ul id="listaBicicletasEstacionadas" class="lista-bikes-estacionadas"></ul>
<style>
.lista-bikes-estacionadas {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 14px;
}
.lista-bikes-estacionadas li {
  background: #232f3e;
  border-radius: 10px;
  box-shadow: 0 2px 8px #0002;
  padding: 14px 18px 10px 18px;
  color: #f5f5f5;
  display: flex;
  flex-direction: column;
  gap: 2px;
  font-size: 1.08em;
  transition: background 0.18s;
}
.lista-bikes-estacionadas li:hover {
  background: #31415a;
}
.lista-bikes-estacionadas .bike-nome {
  font-weight: 600;
  font-size: 1.12em;
  color: #ffeb3b;
  display: flex;
  align-items: center;
  gap: 7px;
}
.lista-bikes-estacionadas .bike-nome::before {
  content: '\1F6B2'; /* emoji bike */
  font-size: 1.1em;
  margin-right: 6px;
}
.lista-bikes-estacionadas .bike-detalhes {
  font-weight: 400;
  font-size: 0.98em;
  color: #b1c6df;
  margin-left: 26px;
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
}
@media (max-width: 540px) {
  .lista-bikes-estacionadas li { font-size: 0.96em; padding: 10px 7px; }
  .lista-bikes-estacionadas .bike-nome { font-size: 1em; }
  .lista-bikes-estacionadas .bike-detalhes { font-size: 0.93em; margin-left: 20px; }
}
</style>
            </div>
        </div>

        <!-- Modal de Entradas Hoje -->
        <div id="modalEntradasHoje" class="modal-estacionadas" style="display:none;">
          <div class="modal-content">
            <span class="close-modal" id="closeModalEntradasHoje">&times;</span>
            <h2>Entradas Hoje</h2>
            <ul id="listaEntradasHoje" class="lista-bikes-estacionadas"></ul>
          </div>
        </div>
        <!-- Modal de Sa√≠das Hoje -->
        <div id="modalSaidasHoje" class="modal-estacionadas" style="display:none;">
          <div class="modal-content">
            <span class="close-modal" id="closeModalSaidasHoje">&times;</span>
            <h2>Sa√≠das Hoje</h2>
            <ul id="listaSaidasHoje" class="lista-bikes-estacionadas"></ul>
          </div>
        </div>

        <!-- Detalhe do Registro (Card) -->
        <div id="detalheRegistroCardContainer"></div>

        <div class="card card-atividade">
            <h3 class="card-title">Atividade Recente</h3>
            <ul id="activity-feed" class="activity-feed"></ul>
        </div>
        
        <div class="card grafico-card">
    <h3 class="card-title">Fluxo por Hora (Hoje)</h3>
    <div class="grafico-container">
        <canvas id="atividadeChart" class="grafico-canvas"></canvas>
    </div>
</div>

<div class="card grafico-card">
    <h3 class="card-title">Distribui√ß√£o de Atividades</h3>
    <div class="grafico-container">
        <canvas id="distribuicaoAtividadesChart" class="grafico-canvas"></canvas>
        <div id="msg-distribuicaoAtividades" class="grafico-msg"></div>
    </div>
</div>

<div class="card grafico-card">
    <h3 class="card-title">Distribui√ß√£o de Tipos de Bicicleta Estacionadas</h3>
    <div class="grafico-container">
        <canvas id="tipoBikeChart" class="grafico-canvas"></canvas>
        <div id="msg-tipoBikeChart" class="grafico-msg"></div>
    </div>
</div>

        <div class="card">
            <h3 class="card-title">Ranking de Usu√°rios com Mais Entradas</h3>
            <ol id="rankingProprietarios" style="margin:0;padding-left:1.5em"></ol>
        </div>

        <div class="card">
            <h3 class="card-title">Ocorr√™ncias Recentes</h3>
            <div id="ocorrenciasContainer">
              <p>Carregando ocorr√™ncias...</p>
            </div>
        </div>

        <!-- Novo Card: Pesquisar e Bloquear Propriet√°rio -->
        <div class="card">
            <h3 class="card-title">Pesquisar e Bloquear Propriet√°rio</h3>
            <div style="display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                <input type="text" id="proprietarioSearch" placeholder="Digite o nome do propriet√°rio"
                       style="padding: 8px; flex: 1; min-width: 200px; border: 1px solid #ddd; border-radius: 4px;">
                <button id="btnBloquearProprietario"
                        style="padding: 8px 16px; background-color: var(--accent-color); color: white;
                               border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Bloquear
                </button>
            </div>
            <p id="statusBloqueio" style="margin: 0; font-weight: bold; font-size: 0.9rem;"></p>
        </div>


    </main>


    <script>
    // Configura√ß√£o da URL base da API
    const API_BASE_URL = 'https://bicicletario-backend.onrender.com';
    
    // --- 2. FUN√á√ïES GLOBAIS ---
let atividadeChartInstance = null;
let distribuicaoAtividadesChartInstance = null;
let tipoBikeChartInstance = null;


async function carregarDadosDashboard(local = 'todos', dataSelecionada = null) {
            const token = sessionStorage.getItem('token');
            
            if (!token) {
                alert("Sess√£o n√£o encontrada ou expirada. Por favor, fa√ßa o login.");
                window.location.href = 'acesso-funcionarios.html';
                return;
            }

            try {
                let apiUrl = `${API_BASE_URL}/api/dashboard/stats?local=${encodeURIComponent(local)}`;
                if (dataSelecionada) {
                    apiUrl += `&data=${encodeURIComponent(dataSelecionada)}`;
                }
                
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': 'Bearer ' + token, 
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401 || response.status === 403) {
                    sessionStorage.clear(); 
                    alert("Sua sess√£o √© inv√°lida ou expirou. Fa√ßa o login novamente.");
                    window.location.href = 'acesso-funcionarios.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Erro ao buscar dados: ${response.statusText}`);
                }
                
                const stats = await response.json();

                // Se a resposta da API vier vazia, usa mock
                if (!stats || Object.keys(stats).length === 0) {
                    throw new Error('Resposta da API vazia, usando dados mock.');
                }

                // Preenche os cards de resumo com dados reais da API
                document.getElementById('totalEstacionadas').textContent = stats.bicicletasEstacionadasAgora || 0;
                document.getElementById('totalEntradasHoje').textContent = stats.entradasHoje || 0;
                document.getElementById('totalSaidasHoje').textContent = stats.saidasHoje || 0;
                document.getElementById('totalOcorrencias').textContent = stats.ocorrenciasHoje || 0;

                
                
                

                // Depois renderiza os outros componentes
                renderizarAtividades(stats.atividadesRecentes);
                renderizarRanking(stats.rankingProprietarios);
                inicializarOuAtualizarGraficos(stats);
                renderizarOcorrencias(stats.ocorrenciasRecentes || []);

            } catch (error) {
                console.warn("Falha ao carregar dados do dashboard ou API vazia. Usando dados mock.", error);
                // MOCK DE DADOS PARA O DASHBOARD
                const now = new Date();
                const stats = {
                    totalBicicletas: 12,
                    dadosEntradasHoje: 5,
                    dadosSaidasHoje: 3,
                    dadosOcorrenciasHoje: 1,
                    
                    atividades: [
                        { tipo: 'entrada', modelo_bicicleta: 'Caloi', nome_proprietario: 'Jo√£o', data_hora_entrada: now.toISOString() },
                        { tipo: 'saida', modelo_bicicleta: 'Oggi', nome_proprietario: 'Maria', data_hora_saida: now.toISOString() },
                        { tipo: 'ocorrencia', descricao_ocorrencia: 'Cadeado danificado', ocorrencia_data_hora: now.toISOString() }
                    ],
                    
                    fluxoPorHora: { horas: ['08h', '09h', '10h', '11h'], entradas: [2, 3, 1, 4], saidas: [1, 2, 0, 2] }
                };
                document.getElementById('totalEstacionadas').textContent = stats.totalBicicletas || 0;
                document.getElementById('totalEntradasHoje').textContent = stats.dadosEntradasHoje || 0;
                document.getElementById('totalSaidasHoje').textContent = stats.dadosSaidasHoje || 0;
                document.getElementById('totalOcorrencias').textContent = stats.dadosOcorrenciasHoje || 0;
                renderizarAtividades(stats.atividades);
                inicializarOuAtualizarGraficos(stats);
                renderizarOcorrencias(stats.ocorrenciasRecentes || []);
            }
}

function renderizarAtividades(atividades = [], local = 'todos') {
    // Normaliza local para compara√ß√£o
    const localNorm = local ? local.trim().toLowerCase() : 'todos';
    if (localNorm !== 'todos') {
        atividades = atividades.filter(a => (a.local_origem || '').trim().toLowerCase() === localNorm);
    }
            const feedContainer = document.getElementById('activity-feed');
            feedContainer.innerHTML = '';
            if (!atividades || atividades.length === 0) {
                feedContainer.innerHTML = '<li>Nenhuma atividade recente para este local.</li>';
                return;
            }
            atividades.forEach(atividade => {
                const item = document.createElement('li');
                const hora = atividade.data_hora_entrada || atividade.data_hora_saida || atividade.ocorrencia_data_hora; // Handle different possible time fields
                const horaFormatada = hora
    ? new Date(hora).toLocaleTimeString('pt-BR', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZone: 'America/Sao_Paulo'
      })
    : 'N/A';
                
                let textoAtividade = '';
                if (atividade.tipo === 'ocorrencia') {
                    textoAtividade = `${atividade.descricao_ocorrencia || 'Ocorr√™ncia'}`;
                } else {
                    textoAtividade = `${atividade.modelo_bicicleta || 'Bicicleta'} (${atividade.nome_proprietario || 'Desconhecido'})`;
                }

                if (atividade.local_origem && atividade.local_origem !== 'todos' && local !== atividade.local_origem && local === 'todos') {
                    textoAtividade += ` - Local: ${atividade.local_origem}`;
                }

                const tipoSafe = atividade.tipo ? atividade.tipo : 'atividade';
item.innerHTML = `<span class="time">${horaFormatada}</span> <span class="type-${tipoSafe}">${tipoSafe.toUpperCase()}:</span> ${textoAtividade}`;
                feedContainer.appendChild(item);
            });
}

// Inst√¢ncias globais dos gr√°ficos para evitar m√∫ltiplas cria√ß√µes


function inicializarOuAtualizarGraficos(stats) {
    // Gr√°fico de Fluxo por Hora
    const fluxoHoras = stats.fluxoPorHora && stats.fluxoPorHora.horas ? stats.fluxoPorHora.horas : ['N/A'];
    const fluxoEntradas = stats.fluxoPorHora && stats.fluxoPorHora.entradas ? stats.fluxoPorHora.entradas : [0];
    const fluxoSaidas = stats.fluxoPorHora && stats.fluxoPorHora.saidas ? stats.fluxoPorHora.saidas : [0];

    const fluxoData = {
        labels: fluxoHoras,
        datasets: [
            { label: 'Entradas', data: fluxoEntradas, backgroundColor: '#26a69a', borderColor: 'var(--card-bg-color)', borderWidth: 2 },
            { label: 'Sa√≠das', data: fluxoSaidas, backgroundColor: '#f39c12', borderColor: 'var(--card-bg-color)', borderWidth: 2 }
        ]
    };
    const atividadeChartCanvas = document.getElementById('atividadeChart');
    if (atividadeChartInstance) {
        atividadeChartInstance.data = fluxoData;
        atividadeChartInstance.update();
    } else if (atividadeChartCanvas) {
        const ctxAtividade = atividadeChartCanvas.getContext('2d');
        atividadeChartInstance = new Chart(ctxAtividade, {
            type: 'bar', data: fluxoData,
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { position: 'top' } },
                layout: { backgroundColor: 'rgba(0,0,0,0)' },
                backgroundColor: 'rgba(0,0,0,0)'
            }
        });
    }

    // Gr√°fico de Distribui√ß√£o de Atividades (Entradas, Sa√≠das, Ocorr√™ncias)
    const distLabels = ['Entradas', 'Sa√≠das', 'Ocorr√™ncias'];
    const distValores = [
        (stats.distribuicaoAtividades && typeof stats.distribuicaoAtividades.entrada === 'number') ? stats.distribuicaoAtividades.entrada : 0,
        (stats.distribuicaoAtividades && typeof stats.distribuicaoAtividades.saida === 'number') ? stats.distribuicaoAtividades.saida : 0,
        (stats.distribuicaoAtividades && typeof stats.distribuicaoAtividades.ocorrencia === 'number') ? stats.distribuicaoAtividades.ocorrencia : 0
    ];
    const distColors = ['#27ae60', '#e67e22', '#c0392b'];
    if (distribuicaoAtividadesChartInstance) {
        distribuicaoAtividadesChartInstance.destroy();
        distribuicaoAtividadesChartInstance = null;
    }
    const distribuicaoAtividadesChartCanvas = document.getElementById('distribuicaoAtividadesChart');
    if (distribuicaoAtividadesChartCanvas) {
        if (distValores.every(v => v === 0)) {
            distribuicaoAtividadesChartCanvas.parentElement.innerHTML = '<h3 class="card-title">Distribui√ß√£o de Atividades</h3><canvas id="distribuicaoAtividadesChart" width="320" height="220"></canvas><div style="color:#888;text-align:center;padding:40px 0;">Sem dados de atividades para exibir.</div>';
        } else {
            const ctxDistribuicao = distribuicaoAtividadesChartCanvas.getContext('2d');
            distribuicaoAtividadesChartInstance = new Chart(ctxDistribuicao, {
                type: 'pie',
                data: {
                    labels: distLabels,
                    datasets: [{
                        label: 'Atividades',
                        data: distValores,
                        backgroundColor: distColors,
                        borderColor: 'var(--card-bg-color)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } },
                    layout: { backgroundColor: 'rgba(0,0,0,0)' },
                    backgroundColor: 'rgba(0,0,0,0)'
                }
            });
        }
    }

    // Gr√°fico de Distribui√ß√£o de Tipos de Bicicleta Estacionadas
    // Debug: Veja o que chega do backend
    console.log('[DEBUG] tiposBicicletaEstacionadas:', stats.tiposBicicletaEstacionadas);
    let tipoLabels = [];
    let tipoValores = [];
    if (Array.isArray(stats.tiposBicicletaEstacionadas) && stats.tiposBicicletaEstacionadas.length > 0) {
        tipoLabels = stats.tiposBicicletaEstacionadas.map(t => t.tipo_bike || 'Desconhecido');
        tipoValores = stats.tiposBicicletaEstacionadas.map(t => {
            // Aceita tanto n√∫mero quanto string num√©rica
            const num = Number(t.total ?? t.quantidade);
            return (typeof num === 'number' && !isNaN(num) && num >= 0) ? num : 0;
        });
    }
    const tipoColors = ['#2a9d8f', '#e67e22', '#2980b9', '#8e44ad', '#f1c40f', '#c0392b', '#16a085'];
    const tipoBikeChartCanvas = document.getElementById('tipoBikeChart');
    if (tipoBikeChartInstance) {
        tipoBikeChartInstance.destroy();
        tipoBikeChartInstance = null;
    }
    if (tipoBikeChartCanvas) {
        // Limpa mensagem de aus√™ncia de dados
        const msgDiv = document.getElementById('msg-tipoBikeChart');
        if (msgDiv) msgDiv.textContent = '';
        // Limpa o gr√°fico anterior
        const ctxTipoBike = tipoBikeChartCanvas.getContext('2d');
        ctxTipoBike.clearRect(0, 0, tipoBikeChartCanvas.width, tipoBikeChartCanvas.height);
        // S√≥ mostra "Sem dados" se n√£o houver labels OU todos os valores forem nulos, zero ou negativos
        const temAlgumValor = tipoValores.some(v => typeof v === 'number' && v > 0);
        if (!tipoLabels.length || !temAlgumValor) {
            if (msgDiv) msgDiv.textContent = 'Sem dados de tipos de bicicleta para exibir.';
            tipoBikeChartCanvas.style.display = 'none';
        } else {
            if (msgDiv) msgDiv.textContent = '';
            tipoBikeChartCanvas.style.display = '';
            tipoBikeChartInstance = new Chart(ctxTipoBike, {
                type: 'doughnut',
                data: {
                    labels: tipoLabels,
                    datasets: [{
                        label: 'Tipos de Bicicleta',
                        data: tipoValores,
                        backgroundColor: tipoColors,
                        borderColor: 'var(--card-bg-color)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } },
                    layout: { backgroundColor: 'rgba(0,0,0,0)' },
                    backgroundColor: 'rgba(0,0,0,0)'
                }
            });
        }
    }
}

// Ranking de Propriet√°rios
function renderizarRanking(ranking = []) {
    const ol = document.getElementById('rankingProprietarios');
    ol.innerHTML = '';
    if (!ranking || ranking.length === 0) {
        ol.innerHTML = '<li>Nenhum registro encontrado.</li>';
        return;
    }
    ranking.forEach((item, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<b>#${idx + 1}</b> ${item.nome_completo} <span style="color:#2a9d8f;font-weight:600">(${item.total_entradas} entradas)</span>`;
        ol.appendChild(li);
    });
}


document.addEventListener('DOMContentLoaded', () => {
        // --- 1. AUTENTICA√á√ÉO, TEMA E LISTENERS ---
    const funcionario = JSON.parse(sessionStorage.getItem('funcionarioLogado') || 'null');
    if (!funcionario) {
        alert("Sess√£o n√£o encontrada ou expirada. Por favor, fa√ßa o login.");
        window.location.href = 'acesso-funcionarios.html';
        return;
    }
    document.getElementById('welcomeMessage').textContent = `Bem-vindo(a), ${funcionario.nome_completo}`;
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
        e.preventDefault();
        sessionStorage.removeItem('funcionarioLogado');
        window.location.href = 'acesso-funcionarios.html';
    });
    // Tema
    const themeToggle = document.getElementById('theme-toggle');
    function aplicarTemaSalvo() {
        const temaSalvo = localStorage.getItem('theme');
        if (temaSalvo === 'dark') {
            document.body.classList.add('dark-theme');
            themeToggle.checked = true;
        } else {
            document.body.classList.remove('dark-theme');
            themeToggle.checked = false;
        }
    }
    themeToggle.addEventListener('change', () => {
        if (themeToggle.checked) {
            document.body.classList.add('dark-theme');
            localStorage.setItem('theme', 'dark');
        } else {
            document.body.classList.remove('dark-theme');
            localStorage.setItem('theme', 'light');
        }
    });
    aplicarTemaSalvo();
    // Listeners para filtro de local e data
    const selectLocal = document.getElementById('filtroLocal');
    const inputData = document.getElementById('filtroData');

    function getDataSelecionada() {
        // Retorna a data no formato yyyy-mm-dd ou a data de hoje
        return inputData && inputData.value ? inputData.value : new Date().toISOString().slice(0,10);
    }

    function atualizarDashboard() {
        const localSelecionado = selectLocal.value.trim();
        const dataSelecionada = getDataSelecionada();
        carregarDadosDashboard(localSelecionado, dataSelecionada);
    }

    selectLocal.addEventListener('change', atualizarDashboard);
    if(inputData) inputData.addEventListener('change', atualizarDashboard);

    // Inicializa o input de data para hoje
    if(inputData) inputData.value = new Date().toISOString().slice(0,10);
    atualizarDashboard();
});
</script>
<script>
function renderizarOcorrencias(ocorrencias) {
  const container = document.getElementById('ocorrenciasContainer');
  container.innerHTML = '';
  if (!ocorrencias || ocorrencias.length === 0) {
    container.innerHTML = '<p>Nenhuma ocorr√™ncia registrada hoje.</p>';
    return;
  }
  const ul = document.createElement('ul');
  ul.className = 'lista-ocorrencias';
  ocorrencias.forEach(oc => {
    const li = document.createElement('li');
    li.innerHTML = `<strong>${oc.nome}</strong>: ${oc.descricao} <br><span style="font-size:0.93em;color:#666;">(${new Date(oc.data).toLocaleString('pt-BR')})</span>`;
    ul.appendChild(li);
  });
  container.appendChild(ul);
}
// Exemplo de chamada (remova depois de integrar com backend):
// renderizarOcorrencias([
//   {nome: 'Thiago', descricao: 'Sem cadeado', data: '2025-07-08T10:22:00'},
//   {nome: 'Maria', descricao: 'Pneu furado', data: '2025-07-08T11:10:00'}
// ]);
</script>
</body>
<script>
console.log('JS do modal carregado!');
// Fun√ß√£o para preencher e mostrar o modal de bicicletas estacionadas
function mostrarModalEstacionadas(bicicletas) {
    const modal = document.getElementById('modalEstacionadas');
    const lista = document.getElementById('listaBicicletasEstacionadas');
    lista.innerHTML = '';
    if (!bicicletas || !Array.isArray(bicicletas) || bicicletas.length === 0) {
        lista.innerHTML = '<li>Nenhuma bicicleta estacionada no momento.</li>';
    } else {
        bicicletas.forEach(bike => {
            const nome = bike.nome_completo || bike.nome_pessoa || bike.nome || 'Desconhecido';
            const tipo = bike.tipo_bike || bike.tipo || 'Desconhecido';
            const modelo = bike.modelo || '';
            const numero = bike.numero_identificacao || '';
            const li = document.createElement('li');
            const status = (bike.status_pessoa === 'Dentro' || !bike.status_pessoa) 
              ? `<span class='bike-status' style='color:#3ec97a;font-weight:600;display:flex;align-items:center;gap:4px;'><span style='font-size:1.15em;'>‚úîÔ∏è</span>Dentro do biciclet√°rio</span>`
              : `<span class='bike-status' style='color:#ff5252;font-weight:600;display:flex;align-items:center;gap:4px;'><span style='font-size:1.15em;'>‚õî</span>Fora do biciclet√°rio</span>`;
            li.innerHTML = `
              <span class="bike-nome">${nome}</span>
              ${status}
              <span class="bike-detalhes">
                ${tipo ? `<span>${tipo}</span>` : ''}
                ${modelo ? `<span>Modelo: ${modelo}</span>` : ''}
                ${numero ? `<span>N¬∫ ${numero}</span>` : ''}
              </span>
            `;
            lista.appendChild(li);
        });
    }
    modal.style.display = 'flex';
}
// Fecha o modal
function fecharModalEstacionadas() {
    document.getElementById('modalEstacionadas').style.display = 'none';
}
// Eventos de clique
const card = document.getElementById('cardEstacionadas');
if (card) {
    card.addEventListener('click', function() {
        let bikes = window.statsUltimo && window.statsUltimo.bicicletasEstacionadas ? window.statsUltimo.bicicletasEstacionadas : [];
        mostrarModalEstacionadas(bikes);
    });
}
// Entradas Hoje - modal detalhado
const cardEntradas = document.getElementById('cardEntradasHoje');
if (cardEntradas) {
    cardEntradas.addEventListener('click', function() {
        let entradas = window.statsUltimo && window.statsUltimo.entradasHojeDetalhadas ? window.statsUltimo.entradasHojeDetalhadas : [];
        mostrarModalEntradasHoje(entradas);
    });
}
// Sa√≠das Hoje - modal detalhado
const cardSaidas = document.getElementById('cardSaidasHoje');
if (cardSaidas) {
    cardSaidas.addEventListener('click', function() {
        let saidas = window.statsUltimo && window.statsUltimo.saidasHojeDetalhadas ? window.statsUltimo.saidasHojeDetalhadas : [];
        mostrarModalSaidasHoje(saidas);
    });
}
// Fechar modais entradas/sa√≠das
const closeEntradas = document.getElementById('closeModalEntradasHoje');
if (closeEntradas) closeEntradas.addEventListener('click', () => document.getElementById('modalEntradasHoje').style.display = 'none');
const closeSaidas = document.getElementById('closeModalSaidasHoje');
if (closeSaidas) closeSaidas.addEventListener('click', () => document.getElementById('modalSaidasHoje').style.display = 'none');
// Fechar ao clicar fora do modal
const modalEntradas = document.getElementById('modalEntradasHoje');
if (modalEntradas) modalEntradas.addEventListener('click', function(e) { if (e.target === this) this.style.display = 'none'; });
const modalSaidas = document.getElementById('modalSaidasHoje');
if (modalSaidas) modalSaidas.addEventListener('click', function(e) { if (e.target === this) this.style.display = 'none'; });

// Fun√ß√µes para preencher listas detalhadas
function mostrarModalEntradasHoje(entradas) {
    const modal = document.getElementById('modalEntradasHoje');
    const lista = document.getElementById('listaEntradasHoje');
    lista.innerHTML = '';
    if (!entradas || !Array.isArray(entradas) || entradas.length === 0) {
        lista.innerHTML = '<li>Nenhuma entrada registrada hoje.</li>';
    } else {
        entradas.forEach(item => {
            const nome = item.nome_completo || 'Desconhecido';
            const tipo = item.tipo_bike || 'Desconhecido';
            const modelo = item.modelo || '';
            const numero = item.numero_identificacao || '';
            const horario = item.data_hora_entrada ? new Date(item.data_hora_entrada).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '';
            const li = document.createElement('li');
            li.innerHTML = `
              <span class="bike-nome">${nome}</span>
              <span class="bike-detalhes">
                ${tipo ? `<span>${tipo}</span>` : ''}
                ${modelo ? `<span>Modelo: ${modelo}</span>` : ''}
                ${numero ? `<span>N¬∫ ${numero}</span>` : ''}
                ${horario ? `<span style='color:#3ec97a;'>üïí ${horario}</span>` : ''}
              </span>
            `;
            lista.appendChild(li);
        });
    }
    modal.style.display = 'flex';
}
function mostrarModalSaidasHoje(saidas) {
    const modal = document.getElementById('modalSaidasHoje');
    const lista = document.getElementById('listaSaidasHoje');
    lista.innerHTML = '';
    if (!saidas || !Array.isArray(saidas) || saidas.length === 0) {
        lista.innerHTML = '<li>Nenhuma sa√≠da registrada hoje.</li>';
    } else {
        saidas.forEach(item => {
            const nome = item.nome_completo || 'Desconhecido';
            const tipo = item.tipo_bike || 'Desconhecido';
            const modelo = item.modelo || '';
            const numero = item.numero_identificacao || '';
            const horario = item.data_hora_saida ? new Date(item.data_hora_saida).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '';
            const li = document.createElement('li');
            li.innerHTML = `
              <span class="bike-nome">${nome}</span>
              <span class="bike-detalhes">
                ${tipo ? `<span>${tipo}</span>` : ''}
                ${modelo ? `<span>Modelo: ${modelo}</span>` : ''}
                ${numero ? `<span>N¬∫ ${numero}</span>` : ''}
                ${horario ? `<span style='color:#ffb300;'>üïí ${horario}</span>` : ''}
              </span>
            `;
            lista.appendChild(li);
        });
    }
    modal.style.display = 'flex';
}
const closeBtn = document.getElementById('closeModalEstacionadas');
if (closeBtn) closeBtn.addEventListener('click', fecharModalEstacionadas);
const modal = document.getElementById('modalEstacionadas');
if (modal) {
    modal.addEventListener('click', function(e) {
        if (e.target === this) fecharModalEstacionadas();
    });
}
// Atualize window.statsUltimo sempre que atualizar os stats
const _oldAtualizaGraficos = window.inicializarOuAtualizarGraficos;
window.inicializarOuAtualizarGraficos = function(stats) {
    window.statsUltimo = stats;
    if (_oldAtualizaGraficos) _oldAtualizaGraficos(stats);
}
</script>
<script>
// Lista de propriet√°rios bloqueados (mock; depois integrar com backend)
    let proprietariosBloqueados = JSON.parse(localStorage.getItem('proprietariosBloqueados') || '[]');

    // Fun√ß√£o para buscar propriet√°rio e exibir status
    document.getElementById('proprietarioSearch').addEventListener('input', function() {
        const nome = this.value.trim().toLowerCase();
        const statusEl = document.getElementById('statusBloqueio');
        if (!nome) {
            statusEl.textContent = '';
            return;
        }
        if (proprietariosBloqueados.includes(nome)) {
            statusEl.textContent = '‚ö†Ô∏è Este propriet√°rio est√° BLOQUEADO';
            statusEl.style.color = 'red';
        } else {
            statusEl.textContent = '‚úÖ Este propriet√°rio est√° ativo';
            statusEl.style.color = 'green';
        }
    });

    // Bot√£o de bloqueio com confirma√ß√£o
    document.getElementById('btnBloquearProprietario').addEventListener('click', function() {
        const nome = document.getElementById('proprietarioSearch').value.trim();
        if (!nome) {
            alert('Digite o nome do propriet√°rio.');
            return;
        }

        // Verifica se j√° est√° bloqueado
        if (proprietariosBloqueados.includes(nome.toLowerCase())) {
            alert(`O propriet√°rio "${nome}" j√° est√° bloqueado.`);
            return;
        }

        // Confirma√ß√£o do funcion√°rio
        const confirmaFuncionario = confirm(`Voc√™ quer solicitar o bloqueio do propriet√°rio "${nome}"?`);
        if (!confirmaFuncionario) return;

        // Aqui voc√™ enviaria a solicita√ß√£o para o backend/admin
        alert(`Solicita√ß√£o de bloqueio de "${nome}" enviada para o administrador.`);

        // Mock: adicionar √† lista de bloqueios pendentes para o admin confirmar
        if (!window.bloqueiosPendentes) window.bloqueiosPendentes = [];
        window.bloqueiosPendentes.push(nome);

        // Salva no localStorage para persistir entre sess√µes
        localStorage.setItem('bloqueiosPendentes', JSON.stringify(window.bloqueiosPendentes));
    });

    // Inicializa bloqueios pendentes do localStorage
    window.bloqueiosPendentes = JSON.parse(localStorage.getItem('bloqueiosPendentes') || '[]');

    // ...existing code...
}
</script>
</html>
